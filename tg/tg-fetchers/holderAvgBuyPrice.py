import httpx
import os
import asyncio
from token_helper import getRpc, getTopHolders, getTokenOverview
from wallet_helper import getWalletAvgPrice
import time

async def getHolderAvgBuyPrice(token: str, limit: int):
    """
    Get the average buy price of a token for its top holders
    """
    token_overview = await getTokenOverview(token)

    if token_overview:
        token_data = token_overview.get('data', {})
        symbol = token_data.get('symbol', '')
        name = token_data.get('name', '')
        logo_url = token_data.get('logoURI', '')
        liquidity = token_data.get('liquidity', 0)
        market_cap = token_data.get('mc', 0)
    else:
        symbol = name = logo_url = ''
        liquidity = market_cap = 0

    token_info = {
        'symbol': symbol,
        'name': name,
        'logoUrl': logo_url,
        'liquidity': liquidity,
        'marketCap': market_cap,
    }
    results = [token_info]
    # holders = await getTopHolders(token, limit)
    async with httpx.AsyncClient() as client:
        # uncomment to actually fetch updated data, commented to save credits only
        # Fetch average buy prices concurrently
        # tasks = [
        #     fetchHolderAvgPrice(holder['owner'], token, client)
        #     for holder in holders
        # ]
        # holders =[{'amount': '393837323381381', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump',
        #             'owner': '5Q544fKrFoe6tsEbD7S8EmxGTJYAKtTVhAW5Q5pge4j1', 'token_account': 'rNLJ1Y4C2pYvD1xigMU53gEKAVehcTjQ5ZdCAgSHQAw',
        #               'ui_amount': 393837323.381381}, {'amount': '51095238095238', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump',
        #                 'owner': 'AM84n1iLdxgVTAyENBcLdjXoyvjentTbu5Q6EpKV1PeG', 'token_account': 'Ga3cr8NSbg8UWCVt5cdSLEVW2tiYb1CDDrZ9fRtBAYnQ',
        #                          'ui_amount': 51095238.095238}, {'amount': '47266440055143', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 
        #                                                          'owner': 'Ggn2LtCYqLjCDGExYTm5aduRNPR8WHPEFuA6nMH6rmbL', 'token_account':
        #                                                            '3yTNnYepLskQKPKzesd5gXkP36EKYVwW1YjfyWQEiuwY', 'ui_amount': 47266440.055143},
        #                                                              {'amount': '25383859820051', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 
        #                                                               'owner':
        #                                                                 'FTg1gqW7vPm4kdU1LPM7JJnizbgPdRDy2PitKw6mY27j',
        #                                                                   'token_account': '5AqF7W2ixNYMqwxtRFskGaMmHRVwfTg3mibeBf8ZeRYQ', 
        #                                                                   'ui_amount': 25383859.820051}, {'amount': '20381662526439', 'decimals': 6,
        #                                                                                                    'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 
        #                                                                                                    'owner': 'BrShW7se5m5nCeupxsgMo6mcGHx256xUE756yqB6PnyC', 'token_account': '59sEsxf6pTgTNCUE1DDZREN7Y82TkqNgtXztBNA3ZCuf', 'ui_amount': 20381662.526439}, {'amount': '18469603013437', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'AEiiScFekUardNBJQb64WRyzyGwATkvEgzyxwrkyhW9f', 'token_account': 'DkXddEdsxAwZb9XTNq6f9nPbNaFm5qRUQfnicA6Q2gC4', 'ui_amount': 18469603.013437}, {'amount': '16743618348479', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'BWrpB3CcSGSmb45NksMffSehQ4QNuLEzUKnUgtvsfL6N', 'token_account': 'ENVWrNomxZrM6v1jnXRwJSmHBheCxzQLfVpkznPZkp4G', 'ui_amount': 16743618.348479}, {'amount': '12573457510571', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '59UiSXYNXaxd5jC3UWPc9HnXrWsCYuA8SP5ynqbv9fWV', 'token_account': '2DuQgW9jHqWYTdxENySX3FJMoW6XEb6aHqLZW7gRf3v9', 'ui_amount': 12573457.510571}, {'amount': '12317993935483', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'ECCKBDWX3MkEcf3bULbLBb9FvrEQLsmPMFTKFpvjzqgP', 'token_account': '4XRPHLWYGc9XhMWYVQ4AT7MFRA1aH35sKnBijysgbrMX', 'ui_amount': 12317993.935483}, {'amount': '11560881734715', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '6mNqs4W3UR4yynj3RWmVnQLMKpyma21Mw9ZcfBNwAg9V', 'token_account': '7phtgMmALRzmxNm2j2woMbYyiLG1EeaXpK8dCshHCnkE', 'ui_amount': 11560881.734715}, {'amount': '10678992270280', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '7Sdxwcy7ofpLkxCJaR6QzN4qu5V5gC8hKAe9FQfyHvMk', 'token_account': 'Gtz6vdCPBycz1tTaoj35EYjzFKvBDCtFAiuKXf5tSAtF', 'ui_amount': 10678992.27028}, {'amount': '9153997370876', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'HSX1unkhjaLHmSd4XbPWoXay35YeS2RVGVeJBPKLTQd5', 'token_account': '5NvZqdbqCEnErtvBvd85wceC1d5Ko2GERFcgFaTdbiJr', 'ui_amount': 9153997.370876}, {'amount': '8461042718355', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '2u1DB7QMqFnRZ7MPggJQp7cPrfbjC3etgeppMm2kv2Zd', 'token_account': '7tyr6YC9Wz3v9AiHtk4jScywmsNBSfdvP6WDuww6qw8S', 'ui_amount': 8461042.718355}, {'amount': '7878163274315', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'D6nUhQ7o3TQwk243mgVS5hsdkuJk71fxZib3KxY4Upyv', 'token_account': '9pdgSTUBykvaoS4nYY3X9te5wQhHW7PJkAGNJbwbD6Hd', 'ui_amount': 7878163.274315}, {'amount': '7843654651390', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '8VsSMNYxwBQgspSbQ71w7eJfMSzALzdKKvgL3ozfntNs', 'token_account': 'ECLqYU9cZtMKZLUeYarXB1qidveM9tiBdaurBaQDNdgg', 'ui_amount': 7843654.65139}, {'amount': '7667043899525', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'D39mf52JoZVnCtksy7csG4xNsz5YAsXCHgyK5ERXJmmm', 'token_account': '7ky6Ho1M7EZ1qnvKn9dUXYscfSbeHZJ1h9gDv5zCbT29', 'ui_amount': 7667043.899525}, {'amount': '7508331463472', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '62k95KmZ6yjQ3qhQMrvscd7yh6WEFqS7oRKLXmdmnoLM', 'token_account': '8AXt7Caszq2uG9m7wpc5cngMWEbzGwKqGTVgqvBXkDPx', 'ui_amount': 7508331.463472}, {'amount': '7367257592664', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'HRnGiwh99qS6XfHMhRmyt8YWWtiNn3RjDoihHvqc6j8G', 'token_account': '3mdZg3Nn1ZhcwZY2NksNmS5YN8ciWwoJcKgxAqD9ueee', 'ui_amount': 7367257.592664}, {'amount': '7008702327728', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'FaDjpoQFQqUE5m83yLY8gqp6dMgH6c4Xx8ucG33zdBrk', 'token_account': '8HKpmox3TepRL9yfCF8Vp8TQtjzAsfheVXXy9p6Zrz6s', 'ui_amount': 7008702.327728}, {'amount': '6610748806300', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '9h8GYpAwYdqLwh3wHfrJYm2kKaxJo2sdjQ7QSncutLQi', 'token_account': '21gvyLuGjWFdpV9qc3jCWrGAdLrTTxqYwE4NWfWWqwY2', 'ui_amount': 6610748.8063}, {'amount': '6267286488491', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '6zFuiktuEyyv2ug8n9rZXVKmeVgX8x2DuXBhuFfk8ynA', 'token_account': 'a7H53kDYhGWv1dvsuCCH3JrQ9LMcvjr4aPTqMAf87L8', 'ui_amount': 6267286.488491}, {'amount': '6143146207129', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'FtSyuMFEJni7bZUreq2xEiFGDKKdvAWTQ4WP2sbwnMdp', 'token_account': 'BSZnkhAag2qjQrFaBcCghDNcFnr4ySCvq1KFucGuVaSa', 'ui_amount': 6143146.207129}, {'amount': '5020105479316', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'AypDMMLZK4joGQ8CJobFz6e8haVkBQafoGdrFM8H3yKM', 'token_account': 'HqXEiQB5M4w6S9c6z8WVK7yJkGXgaDMNShvWKXsaxPix', 'ui_amount': 5020105.479316}, {'amount': '4996342176087', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '7sTgkPKiQg85qTi27aGWBcKsf8LZPufqQU5sA1KtNaV8', 'token_account': '21432ANayk8zJUx9WL8npj4swyDW6fDgndxZkttP5zQ5', 'ui_amount': 4996342.176087}, {'amount': '4708663378815', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'ELtz2XDg3BY3c2K3CiGTv6egyNRbhzzJhZFckCvQiz9y', 'token_account': 'j5MtSqjX1RfsroxhRigqU4kGpu77He9bWLbg7wgTzXB', 'ui_amount': 4708663.378815}, {'amount': '4477592934485', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '7PBXSnAYa2UeWmv9wp7sace5N43Hubpv9Ffuz4h5D7QQ', 'token_account': '3X1N7XsVahVWngWWggKeh2z5pLwkv3aykidik9kzzpJC', 'ui_amount': 4477592.934485}, {'amount': '4326604240776', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '39izaxgq6gR1Ma6Uh4vjGBpCUGXoehzgEqQ16Mh6wVBf', 'token_account': 'EMU9LHSu4cvChcWYUahQyM9qcAXSLMWJ5d3MFqRciiih', 'ui_amount': 4326604.240776}, {'amount': '4263009153530', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'D8m6nVAYST9oiBqs2jZM4tZ7LbkL1rCDhcYyme3LsArr', 'token_account': 'Bh5KqAe1Mjq6Lkp6pMTsK3FRRTk2CYMNbFQUtFeQN1kq', 'ui_amount': 4263009.15353}, {'amount': '4182469121310', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '8VAh3N4sZ6WfweYGdSBw4aUt21TQNhks6qzqJDGHwwp7', 'token_account': 'AmyhSgtFfZJ87zuYBi7FZL9tqzxMDJ4eWCNHbK6b1Kmt', 'ui_amount': 4182469.12131}, {'amount': '4095250908000', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '4dp6koFGapR3eELyTs7AZB5ZmwaHdyvU3vygj3yrzyLP', 'token_account': 'Gt84LaH6Tk1YCnWp3WJGJvZwyamv7n8h5XqCPAB2kNig', 'ui_amount': 4095250.908}, {'amount': '3749295762080', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'Aqa8H5hmHe9MFY9sW6widbqEuaYv7q2KnRo25ApPhWhA', 'token_account': '2MCFiZPGutmpvVDULQsj3wMrtJz5CVhRy512xkmMzDmo', 'ui_amount': 3749295.76208}, {'amount': '3672608939868', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'Fu6955kk7n7AZ8KLWtidAnfGjDaN78AByEJ34vvVV9vP', 'token_account': '6GgxJdFh6WUrEnctfqawCF8fQCcyG7MJDbGEnWDEa6ta', 'ui_amount': 3672608.939868}, {'amount': '3534589560309', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': '6RKmvL7HBbZDAxX6JFCeLJ4apYaRwCwWBQR69qBSw4YG', 'token_account': 'Dfi1pykcy9H9kPdcfbxrJXV86hKCw2rkJQ1FUP6ocGVQ', 'ui_amount': 3534589.560309}, {'amount': '3474189464069', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump', 'owner': 'JA6zU59PjKxYdTfWedyAK2DD9FHQbyu8coF68UM9je2c', 'token_account': '75PeZ3nZ8JLkmY93JdSWaqNBgeD7h7oaD3dVFmAbyAit', 'ui_amount': 3474189.464069}, {'amount': '3164640915833', 'decimals': 6, 'mint': '63EWLHRLxdjoa7VLMNHV9JvJTRNVMkELhUkZHPRhpump',
        #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              'owner': 'EqhcpxYPJev46n6vDKgN7WFxv2iJC8CgDELiayaq19A4', 'token_account': 'AkrVXVFRwAArtkY6iVbpJVPD9hbEqZ6XTy7m6oqK94Eh', 'ui_amount': 3164640.915833}]
        holders = [{'amount': '22712305153660', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '7tco85pE38UHUmaSNZRnsvcw2GXJv5TowP1tSw3GAL6M', 'token_account': '8KK2Tf7z4g63xsRUX1L41QipKvmMe9UfUiEbBvGaVjAx', 'ui_amount': 22712305.15366}, {'amount': '18437114014966', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '3rJBDvUJqwE6dPsiTWkw9ycixGZD93LHA7X8U8KuTkpJ', 'token_account': '299mRdis64c4ihooZrqa2Xmm5F5k3Y6GXSCjS758QnW7', 'ui_amount': 18437114.014966}, {'amount': '17547544152607', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'G1JdViWzkfAQBMUzLwiFdUko1rm2L7xjKCXWejh5DAo4', 'token_account': 'HuXx3BL5PT8dJmfLq8S1VzFE58zjskGqn4hVvGkg2QbN', 'ui_amount': 17547544.152607}, {'amount': '17462061790440', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'GLYhYFAocMTQupx6VSj7TA28CsRTR5U2s3NAVatAAxDV', 'token_account': 'GBEYnraB1Z5UGffptyZCPscjmmiSoC4zwUf2QVZ8R4KE', 'ui_amount': 17462061.79044}, {'amount': '16753474798214', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '48ryuZZRgEEsjJ3UoQQiYCHJsHiqjf7SeuSucxfGvH3F', 'token_account': 'D87qqFzhgbChs9JwkHzmCnGynmJjx91cKFPSpKyKQMY2', 'ui_amount': 16753474.798214}, {'amount': '13271269318567', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '5LWgu2A98LEhYQmubgwaD5989VyQ26px2kVcbYGY81kR', 'token_account': '7Pz9AVP6dwW3MMtVLXEyHf8FNxvf2Vqj9nCWi1gxwcWC', 'ui_amount': 13271269.318567}, {'amount': '13202743311084', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '5Q544fKrFoe6tsEbD7S8EmxGTJYAKtTVhAW5Q5pge4j1', 'token_account': '6q65PT9hy9mrzWak9s7Vk5GXbRKx7ZDAj9GZyCTbyQnn', 'ui_amount': 13202743.311084}, {'amount': '11750373845517', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '2K8DNo6Ag8LwKvazLUjNqG8p9duqTaV4B1n5tHEiUKuh', 'token_account': 'C63vU7yeYtKExpsuxLPuWcpaGeeU3QdyyWXyxLNTwUuT', 'ui_amount': 11750373.845517}, {'amount': '10854620000000', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'EvVrwnrpHnmm8BXSs58YJcCAQo7L8mbWDTW47whdZZsp', 'token_account': 'Bx5CZcr7YEDJs4ebitZ7ctWFr1vhEs7sxBPzX8B3VHR2', 'ui_amount': 10854620}, {'amount': '10266496591311', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'ChHDA9pXFogfJVMhvT8nFyPa5V1JmUWb2fvWbBzDypXm', 'token_account': 'VtVgyrtSFYxNpp1q5NeS7CbRH2kCB3bwF9NXDCprLNn', 'ui_amount': 10266496.591311}, {'amount': '10174963424208', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '6BE7yFZyvQRyg2vveW5GHPgvgorb6f8BWVfJir7zRVXH', 'token_account': 'EtqwyTiuEWTsGFHZEJ3UiTxqi6yy5NM4Th5ySsYY9yzq', 'ui_amount': 10174963.424208}, {'amount': '10047634617660', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '879G2oLedweGKYyb1EPg5Km8RvfZXfpJ22YxH3zXwiwd', 'token_account': 'AWn2ehyYewza4AdbLbxp3PGdZ6Mqg7QfTmcqHvHe4rCN', 'ui_amount': 10047634.61766}, {'amount': '10000000010435', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'GK7CaLjBTME8r57Z52t8f8gHbp774rP83qNxPQL1UZDr', 'token_account': 'Frm84Ax9g3r3Lqup34FqeYVZ3ANEyASoyztvZCt1HST4', 'ui_amount': 10000000.010435}, {'amount': '9863360239264', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'BR9pXuu7PdoPFcUh9v6KLLm3L6o9DsMBmzMDoZUMA5de', 'token_account': '4Y71MZWtFcH96Lgw4Q3VCzWzCr6hgjhqD3iLwhtqtK9Q', 'ui_amount': 9863360.239264}, {'amount': '9854645000000', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'B3LoxufLQvXUFNQYV9Z7jDQyy5M2LsGb7bTwDp55BDbQ', 'token_account': 'Dq2x2BvXRaAxSrCHGgGzXB6t9tsNMPdBZcUbEdxcNDAJ', 'ui_amount': 9854645}, {'amount': '9624664960439', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': 'CP8N3DrkohjjnCYLbegUo2tEGUkfmja1yqdD5NtBCkk1', 'token_account': 'AjiS5ZnTF634EzwR5Xos4p3AZvcJqzFJn9TG2jwzUn69', 'ui_amount': 9624664.960439}, {'amount': '9421547000000', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '5JKXc7RJ4zYdxEimJAomb8pa3vedTjHTp8q6HHD5GQGq', 'token_account': 'FCpvL6bDB86zcgxp6KaXB5KBtPAJXgWYafmGj2Yx2YpQ', 'ui_amount': 9421547}, {'amount': '9245120000000', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '3E5VLcNAfvgKFmTHaRuay7G6sMFB6ffDasV6dLgsCt6m', 'token_account': 'AEFymfXJrgCawsBCtjtyFqrCSZ8Zrv3Fo1QGaRrb1LRu', 'ui_amount': 9245120}, {'amount': '9126398763811', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '7uAFEzFgfkLyPJjftckL9cKU5o2ypbf2MrPPJH4mjN1P', 'token_account': '7WBVk5SB9JJm17oQUtWmGZqxhUyrSCAShpJMh6B4i2gb', 'ui_amount': 9126398.763811}, {'amount': '9062009295567', 'decimals': 6, 'mint': '9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump', 'owner': '6PYFiWbmRKD73CNHM7WNsiknqiZQr3KW9qbHkpDKP3C3', 'token_account': '83PcEMT4kSHh8uSBYuLaViaHicJLwWpkdxuiWegEP7ri', 'ui_amount': 9062009.295567}]
        tasks = [
            fetchHolderAvgPrice(holder['owner'], token, client)
            for holder in holders
        ]
        responses = await asyncio.gather(*tasks)
        avg_buy_price_sum = 0

        for holder, avg_buy_price in zip(holders, responses):
            holder_result = {
                'address': holder['owner'],
                'avgBuyPrice': avg_buy_price
            }
            results.append(holder_result)
            if avg_buy_price is not None:
                avg_buy_price_sum += avg_buy_price

        avg_buy_price = avg_buy_price_sum / len(holders) if holders else 0
        results.append({
            'avgBuyPrice': avg_buy_price
        })

        return results

async def fetchHolderAvgPrice(holder: str, token: str, client: httpx.AsyncClient):
    print("Fetching avg buy price for", holder, "in", token)
    """
    Fetch the average buy price of a token for a specific wallet
    """
    return await getWalletAvgPrice(holder, token, "buy", client)

if __name__ == "__main__":
    token_id = "9XS6ayT8aCaoH7tDmTgNyEXRLeVpgyHKtZk5xTXpump"
    limit = 20

    start_time = time.time()
    results = asyncio.run(getHolderAvgBuyPrice(token_id, limit))
    print(results)
    print(f"Execution time: {time.time() - start_time} seconds")
